<!DOCTYPE html>
<html>
<head>
  <title>Event planner</title>
  <base href="/">
  <link rel="stylesheet" href="/lib/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="/lib/bootstrap/css/bootstrap-theme.min.css">
  <style>
  #eventImage {
        height: 350px;
        width: 100%;
  }
  .imageDiv{
    position:relative;
    }
    .post-content {
    margin-top: 120px;
    background: none repeat scroll 0 0 #FFFFFF;
    opacity: 0.9;
    top:0;
    left:0;
    position: absolute;
}

    
    #map {
        height: 400px;
        width: 100%;
        margin: 0px;
    }
    .no-bottom-margin {
        margin-bottom: 0px;
    }
    
    .stretch-text {
    text-align: justify;
    text-justify: inter-word;    }

     .left-right-padding {
         padding-left: 30px;
         padding-right: 30px;
     }
      .start-hidden {
          display: none;
      }
  </style>

</head>
<body>

  <div class="navbar navbar-default no-bottom-margin">
    <div class="container">
      <div id="navbar-main">
        <ul class="nav navbar-nav">
          <li><a href="/">Home</a></li>
          <li><a href="/events.html">Events</a></li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <li><a href="/login.html">Sign in</a></li>
          <li><a href="/profile.html"></a></li>
        </ul>
      </div>
    </div>
  </div>

<div class="row">
    <div class="col-sm-12">
        <div class="imageDiv">
            <img id="eventImage" src="#" alt="event image"/>
            <div class="col-sm-12  caption post-content">
                <div class="text-center">
                     <h1><p class="" id="titleParagraph"></p></h1>
                    <h3><p class="" id="quickDescriptionParagraph"></p></h3>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="col-sm-6 form-group text-right">
            <h3>
                <small><label class=" control-label">Where</label></small>
                <p class="form-control-static" id="placeParagraph"></p>
                <small><label class=" control-label">When</label></small>
                <p class="form-control-static" id="dateParagraph"></p>
                <small><label class=" control-label">How much</label></small>
                <p class="form-control-static" id="priceParagraph"></p>
                <small><label class=" control-label">Category</label></small>
                <p class="form-control-static" id="categoryParagraph"></p>
                <small><label class=" control-label">Brought By</label>
                <p class="form-control-static" id="authorParagraph"></p></small>
            </h3>
        </div>
        <div class="col-sm-6 form-group text-center stretch-text">
            <h3><small><label class=" control-label">Description</label></small></h3>
            <p class="form-control-static" id="descriptionParagraph"></p>
        </div>
        
        <div class="col-sm-12 form-group text-center">
            <button type="button" hidden id="attendEvent" class="btn btn-primary left-right-padding start-hidden">I will come!</button>
            <button type="button" hidden id="unattendEvent" class="btn btn-primary start-hidden">Cancel confirmation :(</button>
            <br>
            <br>
            <div hidden class="alert alert-success" role="alert" id="successAttendingDiv">
                <strong>Hurray! </strong>You said you're attending!!
            </div>   
            <div hidden class="alert alert-danger" role="alert" id="alertUnattendingDiv">
                <strong>Ahh! </strong>Such a pity that you can't come!
            </div>               
            <hr>
            <label class="col-sm-12 control-label">Attending people</label>
            <div id="attendingPeopleDiv" class="form-group">
            </div>
        </div>
    </div>
    <div id="map"></div>
    <div class="col-sm-12">
        <hr>
        <label class="col-sm-12 control-label">Events from followed</label>
        <div id="friendsEventsDiv" class="form-group">
        </div>
        <hr>
        <label class="col-sm-12 control-label">Events by location</label>
        <div id="eventsByLocationDiv" class="form-group">
        </div>
        <hr>
        <label class="col-sm-12 control-label">All Events</label>
        <div id="eventsDiv" class="form-group">
        </div>
    </div>
</div>


    

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAvkp-hH2o_yI7V6rintnrmqZ_uwOZQEpE"></script>
  <script src="js/authentication.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/common.js"></script>
  <script src="js/events.js"></script>
    <script src="js/profiles.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.7.0/moment.min.js" type="text/javascript"></script>
  <script>

        
        fetchAllEvents()
            .then(function(res) {
                //console.log(res);
                res.forEach((event) => {
                  $('#eventsDiv').prepend(`${event.title} <a href="/event_new.html?_id=${event._id}">link</a> <br>`);
                });
            })
            .catch(function(err){
                console.log(err);
            });
        fetchFriendsEvents()
            .then(function(res) {
                const events = eval("(" + res + ")");
                Object.keys(events).map((e) => {
                    $('#friendsEventsDiv').prepend(`${events[e]} ${e} <a href="/event_new.html?_id=${events[e]}">link</a> <br>`);
                });

            })
            .catch(function(err){
                console.log(err);
            });
        fetchEventsByLocation()
            .then(function(res) {
                //console.log(res);
                res.forEach((event) => {
                  $('#eventsByLocationDiv').prepend(`${event.title} <a href="/event_new.html?_id=${event._id}">link</a> <br>`);
                });
            })
            .catch(function(err){
                console.log(err);
            });
        let authorProfile;
        const eventId = getUrlParameter('_id');
        if (eventId) {
            const event = fetchEventById(eventId)
                .then(function(event){
                    //console.log(event);
                    $('#titleParagraph').text(event.title);

                    $('#placeParagraph').text(event.place_address);
                    $('#latParagraph').text(event.place_address_lat);
                    $('#lngParagraph').text(event.place_address_lng);
                    const formattedDate = moment(event.date).format('llll');
                    $('#dateParagraph').text(formattedDate);
                    $('#descriptionParagraph').text(event.description);
                    $('#priceParagraph').text(event.price);
                    $('#categoryParagraph').text(event.category);
                    $('#quickDescriptionParagraph').text(event.quick_description);
                    $('#eventImage').attr("src", event.image.replace("images/", "images/cropped/"));
                    event.attending.forEach((id) => {
                        $('#attendingPeopleDiv').append(`${id} <br>`);
                    });

                    const authorProfile = fetchProfileById(event.created_by)
                        .then(function(res) {
                            console.log(res);
                            $('#authorParagraph').append(`<a href="/profile.html?_id=${res._id}">${res.name}</a>`);
                            console.log(res.attending_events);
                            if ($.inArray(eventId, res.attending_events)) {
                                $('#attendEvent').show();
                            } else {
                                $('#unattendEvent').show();
                            }
                        })
                        .catch(function(err){
                            console.log(err);
                        });

                        let map;
                        let marker;
                        let mapOptions;
                        let mapCanvas;
                        let mapBig;

                        mapCanvas = document.getElementById('map');
                        mapOptions = {
                            center: new google.maps.LatLng(event.place_address_lat, event.place_address_lng),
                            zoom: 8,
                            mapTypeId: google.maps.MapTypeId.ROADMAP,
                            scrollwheel: false,
                            draggable: false
                        }
                        console.log(event.place_address_lat);
                        console.log(event.place_address_lng);
                        map = new google.maps.Map(mapCanvas, mapOptions);
                        marker = new google.maps.Marker({
                            position: new google.maps.LatLng(event.place_address_lat, event.place_address_lng),
                            map: map,
                        });
                        google.maps.event.addListener(map, 'mouseout', function(){
                            this.setOptions({scrollwheel:false});
                        });
                        map.addListener('click', function() {
                            map.set('scrollwheel', true);
                        });
                })
                .catch(function(err){
                    console.log(err);
                });



            // id taken from url
            $('#attendEvent').on('click', function() {
                attendEvent(eventId)
                    .then(function(result) {
                        //console.log(result);
                        $('#alertUnattendingDiv').hide();
                        $('#successAttendingDiv').show();
                        $('#attendEvent').hide();
                        $('#unattendEvent').show();
                    })
                    .catch(function(err) {
                        console.log(err);
                    });
            });

            // id taken from url
            $('#unattendEvent').on('click', function() {
                unattendEvent(eventId)
                    .then(function(result) {
                        //console.log(result);
                        $('#successAttendingDiv').hide();
                        $('#alertUnattendingDiv').show();
                        $('#attendEvent').show();
                        $('#unattendEvent').hide();
                    })
                    .catch(function(err) {
                        console.log(err);
                    });
            });

            
            

        }
  </script>
</body>
</html>